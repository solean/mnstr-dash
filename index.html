<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MNSTR EV Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bungee:wght@400&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --font-heading: 'Bungee', 'Space Grotesk', system-ui, -apple-system, sans-serif;
      --font-body: 'Space Grotesk', system-ui, -apple-system, sans-serif;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
    }

    :root[data-theme="light"] {
      --bg: radial-gradient(circle at 25% -10%, rgba(246, 201, 14, 0.18), transparent 30%), radial-gradient(circle at 75% 110%, rgba(37, 99, 235, 0.12), transparent 32%), #ffffff;
      --panel: #ffffff;
      --panel-strong: #f1f5f9;
      --accent: #f6c90e;
      --accent-2: #1d4ed8;
      --text: #0b1120;
      --subtext: #4b5563;
      --danger: #d32f2f;
      --positive: #1b5e20;
      --border: rgba(15, 17, 32, 0.08);
      --error-bg: rgba(229, 57, 53, 0.08);
      --error-border: rgba(229, 57, 53, 0.35);
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
      color-scheme: light;
    }

    :root[data-theme="dark"] {
      --bg: radial-gradient(circle at 50% -10%, rgba(246, 201, 14, 0.3), transparent 35%), radial-gradient(circle at 45% 120%, rgba(37, 99, 235, 0.28), transparent 38%), linear-gradient(140deg, #0b1224, #0f274d 50%, #0b1936 100%);
      --panel: rgba(255, 255, 255, 0.1);
      --panel-strong: rgba(255, 255, 255, 0.18);
      --accent: #f6c90e;
      --accent-2: #4f8bff;
      --text: #fdfdfd;
      --subtext: #d8deef;
      --danger: #ffb3ba;
      --positive: #b7ffcf;
      --border: rgba(255, 255, 255, 0.1);
      --error-bg: rgba(255, 179, 186, 0.12);
      --error-border: rgba(255, 179, 186, 0.55);
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      color-scheme: dark;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      padding: 28px 18px 48px;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: linear-gradient(135deg, var(--panel), rgba(255, 255, 255, 0.08));
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 22px 22px 18px;
      box-shadow: var(--shadow);
    }

    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 12px;
      color: var(--accent);
      margin: 0;
    }

    h1 {
      margin: 0;
      font-size: clamp(26px, 4vw, 34px);
      font-family: var(--font-heading);
      font-weight: 400;
      letter-spacing: -0.5px;
    }

    .lede {
      margin: 0;
      color: var(--subtext);
      max-width: 650px;
      line-height: 1.5;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-top: 4px;
    }

    button {
      border: none;
      padding: 11px 16px;
      border-radius: 12px;
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      color: #0a0d1b;
      font-weight: 700;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.2s ease;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.32);
    }

    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.04);
    }

    button:active {
      transform: translateY(0);
      filter: brightness(0.96);
    }

    .ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      box-shadow: none;
    }

    .ghost:hover { filter: none; transform: none; }
    .ghost:active { filter: none; }

    .status {
      color: var(--subtext);
      font-size: 14px;
    }

    main {
      margin-top: 18px;
      display: grid;
      gap: 14px;
    }

    .tier {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .tier-head {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 10px 14px;
      margin-bottom: 12px;
    }

    .tier h2 {
      margin: 0;
      font-size: 20px;
      letter-spacing: -0.2px;
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(246, 201, 14, 0.2), rgba(37, 99, 235, 0.16));
      color: var(--text);
      font-size: 13px;
      font-weight: 700;
      border: 1px solid var(--border);
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .metric {
      padding: 12px;
      border-radius: 14px;
      background: var(--panel-strong);
      border: 1px solid var(--border);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.05);
    }

    .metric label {
      display: block;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--subtext);
      margin-bottom: 5px;
    }

    .metric strong {
      font-size: 20px;
      font-weight: 600;
      display: block;
    }

    .metric small {
      color: var(--subtext);
      display: block;
      margin-top: 4px;
      font-size: 13px;
    }

    .metric .positive { color: var(--positive); }
    .metric .negative { color: var(--danger); }

    .card-toggle {
      margin-top: 10px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    .card-toggle summary {
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      cursor: pointer;
      user-select: none;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .card-toggle summary::-webkit-details-marker {
      display: none;
    }

    .card-toggle .chevron {
      transition: transform 0.15s ease;
      font-size: 18px;
    }

    .card-toggle[open] .chevron {
      transform: rotate(180deg);
    }

    .card-table {
      padding: 0 12px 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    th, td {
      padding: 8px 6px;
      text-align: left;
      font-size: 14px;
    }

    th {
      color: var(--subtext);
      font-weight: 600;
      letter-spacing: 0.02em;
      border-bottom: 1px solid var(--border);
    }

    tr + tr td {
      border-top: 1px solid var(--border);
    }

    .card-name { font-weight: 600; }
    .card-meta {
      display: block;
      color: var(--subtext);
      font-size: 12px;
      margin-top: 2px;
    }
    .value-cell { color: var(--text); white-space: nowrap; }
    .prob-cell { color: var(--subtext); white-space: nowrap; }

    .empty {
      color: var(--subtext);
      font-size: 14px;
      margin: 6px 0 0;
    }

    .error {
      padding: 12px 14px;
      border-radius: 12px;
      background: var(--error-bg);
      border: 1px solid var(--error-border);
      color: var(--danger);
      margin-top: 12px;
    }

    .loader {
      margin-top: 14px;
      color: var(--subtext);
      font-size: 14px;
    }

    @media (max-width: 640px) {
      body { padding: 18px 14px 34px; }
      header { padding: 18px 16px; }
      .metric strong { font-size: 18px; }
      th, td { font-size: 13px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <p class="eyebrow">Live EV Monitor</p>
      <h1>MNSTR Gacha Value Dashboard</h1>
      <p class="lede">Pull fresh pack pricing and chase card odds straight from the MNSTR API. We compute expected value, profit, and hit odds so you know how the packs pencil out right now.</p>
      <div class="actions">
        <button id="refresh">Refresh data</button>
        <button id="theme-toggle" class="ghost" type="button">Dark mode</button>
        <span class="status" id="status">Waiting to load…</span>
      </div>
    </header>

    <main id="tiers"></main>
    <div class="loader" id="loader">Loading live data…</div>
    <div class="error" id="error" hidden></div>
  </div>

  <script>
    const BASE_URL = 'https://api.mnstr.xyz';
    const PRICE_URL = `${BASE_URL}/gacha/prices`;

    const currency = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
    const percent = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 });

    const tierContainer = document.getElementById('tiers');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const loaderEl = document.getElementById('loader');
    const refreshBtn = document.getElementById('refresh');
    const themeToggle = document.getElementById('theme-toggle');

    refreshBtn.addEventListener('click', () => loadData());
    themeToggle.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      setTheme(next);
    });

    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      themeToggle.textContent = theme === 'dark' ? 'Light mode' : 'Dark mode';
    }

    const savedTheme = localStorage.getItem('theme');
    setTheme(savedTheme || 'light');

    function showError(message) {
      errorEl.textContent = message;
      errorEl.hidden = false;
    }

    function clearError() {
      errorEl.hidden = true;
      errorEl.textContent = '';
    }

    function probabilityScale(cards) {
      const rawSum = cards.reduce((sum, card) => sum + Number(card.probability), 0);
      if (Math.abs(rawSum - 1) < 1e-6) return 1;
      if (Math.abs(rawSum - 100) < 1e-2) return 0.01;
      return 1 / rawSum;
    }

    function computeMetrics(cards, priceUsd) {
      const costOfPack = Number(priceUsd);
      const scale = probabilityScale(cards);

      const expectedValue = cards.reduce((sum, card) => {
        const p = Number(card.probability) * scale;
        const value = Number(card.fmv);
        return sum + p * value;
      }, 0);

      const sorted = [...cards].sort((a, b) => Number(a.fmv) - Number(b.fmv));
      let cumulative = 0;
      let medianValue = 0;
      for (const card of sorted) {
        cumulative += Number(card.probability) * scale;
        if (cumulative >= 0.5) {
          medianValue = Number(card.fmv);
          break;
        }
      }

      const oddsOverCost = cards.reduce((sum, card) => {
        if (Number(card.fmv) >= costOfPack) {
          return sum + Number(card.probability) * scale;
        }
        return sum;
      }, 0) * 100;

      const profit = expectedValue - costOfPack;
      const evPercent = (expectedValue / costOfPack) * 100;
      const profitPercent = (profit / costOfPack) * 100;

      return {
        expectedValue,
        medianValue,
        oddsOverCost,
        costOfPack,
        profit,
        evPercent,
        profitPercent,
        probScale: scale
      };
    }

    function renderTier(tierName, tierInfo) {
      const { cards, metrics } = tierInfo;
      const cardRows = cards.map(card => {
        const chance = Number(card.probability) * metrics.probScale * 100;
        const probDisplay = percent.format(chance);
        const title = card.title || card.playerName || card.cardName || 'Card';
        const setYear = [card.year, card.set].filter(Boolean).join(' · ');
        const grading = [card.gradingCompany, card.grading].filter(Boolean).join(' ');
        const metaPieces = [setYear, grading].filter(Boolean);
        return `
          <tr>
            <td>
              <span class="card-name">${title}</span>
              ${metaPieces.length ? `<span class="card-meta">${metaPieces.join(' • ')}</span>` : ''}
            </td>
            <td class="value-cell">${currency.format(Number(card.fmv))}</td>
            <td class="prob-cell">${probDisplay}%</td>
          </tr>
        `;
      }).join('');

      return `
        <section class="tier">
          <div class="tier-head">
            <h2>${tierName} Pack</h2>
            <span class="pill">${cards.length} chase cards</span>
          </div>
          <div class="metrics">
            <div class="metric">
              <label>Expected Value</label>
              <strong>${currency.format(metrics.expectedValue)}</strong>
              <small>Pack price ${currency.format(metrics.costOfPack)}</small>
            </div>
            <div class="metric">
              <label>Median Card</label>
              <strong>${currency.format(metrics.medianValue)}</strong>
              <small>50% of pulls at least this value</small>
            </div>
            <div class="metric">
              <label>Profit Odds</label>
              <strong>${percent.format(metrics.oddsOverCost)}%</strong>
              <small>Chance pull ≥ pack cost</small>
            </div>
            <div class="metric">
              <label>Profitability</label>
              <strong class="${metrics.profitPercent >= 0 ? 'positive' : 'negative'}">
                ${metrics.profitPercent >= 0 ? '+' : ''}${percent.format(metrics.profitPercent)}%
              </strong>
              <small>EV vs cost</small>
            </div>
          </div>
          ${cards.length ? `
            <details class="card-toggle">
              <summary>
                <span>Show chase cards (${cards.length})</span>
                <span class="chevron">⌄</span>
              </summary>
              <div class="card-table">
                <table>
                  <thead>
                    <tr>
                      <th>Card</th>
                      <th>FMV</th>
                      <th>Pull %</th>
                    </tr>
                  </thead>
                  <tbody>${cardRows}</tbody>
                </table>
              </div>
            </details>
          ` : '<p class="empty">No card data available.</p>'}
        </section>
      `;
    }

    async function loadData() {
      loaderEl.textContent = 'Loading live data…';
      loaderEl.hidden = false;
      clearError();
      tierContainer.innerHTML = '';
      statusEl.textContent = 'Fetching current prices…';
      refreshBtn.disabled = true;

      try {
        const priceResponse = await fetch(PRICE_URL);
        if (!priceResponse.ok) throw new Error('Failed to fetch prices');
        const priceData = await priceResponse.json();
        const tiers = Object.keys(priceData.data || {});

        const tierResults = await Promise.all(tiers.map(async (tierName) => {
          const cardUrl = `${BASE_URL}/gacha/chase-cards?tier=${encodeURIComponent(tierName)}`;
          const cardRes = await fetch(cardUrl);
          if (!cardRes.ok) throw new Error(`Failed to fetch cards for ${tierName}`);
          const payload = await cardRes.json();
          const cards = payload.data || [];
          const metrics = computeMetrics(cards, priceData.data[tierName].priceUsd);
          return { tierName, cards, metrics };
        }));

        tierContainer.innerHTML = tierResults
          .map(({ tierName, cards, metrics }) => renderTier(tierName, { cards, metrics }))
          .join('');

        const time = new Date();
        statusEl.textContent = `Updated ${time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
      } catch (err) {
        console.error(err);
        showError(err.message || 'Unable to load data right now.');
        statusEl.textContent = 'Error loading data';
      } finally {
        loaderEl.hidden = true;
        refreshBtn.disabled = false;
      }
    }

    loadData();
  </script>
</body>
</html>
